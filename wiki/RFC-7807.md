# RFC 7807 - Problem Details para APIs HTTP

Este proyecto implementa el estándar **RFC 7807** para comunicar errores de manera consistente y legible.

---

## ¿Qué es RFC 7807?

RFC 7807 define un formato estándar para representar errores en APIs HTTP. Proporciona:
- Estructura consistente para todos los errores
- Información legible por humanos y máquinas
- Extensibilidad para detalles adicionales

**Referencia**: [RFC 7807 - Problem Details for HTTP APIs](https://datatracker.ietf.org/doc/html/rfc7807)

---

## Estructura de Problem Details

```json
{
  "type": "string",      // URI que identifica el tipo de problema
  "title": "string",     // Título legible del error
  "status": "number",    // Código de estado HTTP
  "detail": "string",    // Explicación específica del error
  "instance": "string"   // URI del recurso que causó el error (opcional)
}
```

---

## Tipos de Problemas

### Error de Validación
**Código**: 422 Unprocessable Entity

```json
{
  "type": "/problems/validation-error",
  "title": "Error de Validación",
  "status": 422,
  "detail": "La entrada no es ni un número válido ni un numeral romano válido",
  "instance": "/api/convert"
}
```

**Cuándo ocurre**: Entrada vacía, caracteres inválidos, formato no reconocido.

---

### Valor Fuera de Rango
**Código**: 422 Unprocessable Entity

```json
{
  "type": "/problems/range-error",
  "title": "Valor Fuera de Rango",
  "status": 422,
  "detail": "No se puede convertir 4000: El número debe estar entre 1 y 3999",
  "instance": "/api/convert"
}
```

**Cuándo ocurre**: Número menor a 1 o mayor a 3999.

---

### Numeral Romano Inválido
**Código**: 422 Unprocessable Entity

```json
{
  "type": "/problems/invalid-numeral",
  "title": "Numeral Romano Inválido",
  "status": 422,
  "detail": "Numeral romano inválido: IIII",
  "instance": "/api/convert"
}
```

**Cuándo ocurre**: Numeral romano con patrón inválido (IIII, VV, etc.).

---

### Solicitud Malformada
**Código**: 400 Bad Request

```json
{
  "type": "/problems/malformed-request",
  "title": "Solicitud Malformada",
  "status": 400,
  "detail": "El campo value es requerido",
  "instance": "/api/convert"
}
```

**Cuándo ocurre**: JSON inválido, campo faltante, tipo de dato incorrecto.

---

### Error Interno del Servidor
**Código**: 500 Internal Server Error

```json
{
  "type": "/problems/internal-error",
  "title": "Error Interno del Servidor",
  "status": 500,
  "detail": "Se ha producido un error inesperado",
  "instance": "/api/convert"
}
```

**Cuándo ocurre**: Error inesperado no manejado.

---

## Implementación en el Proyecto

### Middleware Centralizado

El archivo `src/infrastructure/http/errorHandler.ts` proporciona un middleware que captura todas las excepciones y las transforma en respuestas RFC 7807:

```typescript
export function withErrorHandler<T>(
  handler: () => T | Promise<T>,
  instance: string
): Promise<NextResponse>
```

### Clases de Error

Las excepciones del dominio incluyen propiedades RFC 7807:

```typescript
// src/shared/errors.ts
export class ConversionError extends Error {
  problemType: string;    // URI del tipo
  problemTitle: string;   // Título legible
  statusCode: number;     // Código HTTP
}

export class ValidationError extends Error {
  problemType: string;
  problemTitle: string;
  statusCode: number;
}
```

### Content-Type

Todas las respuestas de error usan el Content-Type correcto:

```
Content-Type: application/problem+json
```

---

## Códigos de Estado HTTP

### 400 Bad Request
Error de sintaxis en la petición.
- JSON malformado
- Campo requerido faltante
- Tipo de dato incorrecto

### 422 Unprocessable Entity
Error semántico en la lógica de negocio.
- Número fuera de rango (0, 4000+)
- Numeral romano con patrón inválido
- Entrada no reconocida

### 500 Internal Server Error
Error inesperado del servidor.
- Excepción no manejada
- Error de infraestructura

---

## Manejo en el Frontend

El frontend (`lib/error-messages.ts`) mapea los tipos de error a mensajes educativos:

```typescript
if (isRFC7807Error(errorData)) {
  const { title, description, educationalTip } = formatErrorForToast(errorData);

  toast.error(title, {
    description: `${description}\n\n${educationalTip}`,
    duration: 7000,
  });
}
```

Esto proporciona feedback claro al usuario explicando qué salió mal y cómo corregirlo.

---

## Beneficios

1. **Consistencia**: Todas las respuestas de error tienen la misma estructura
2. **Legibilidad**: Títulos y detalles en español para usuarios
3. **Debugging**: URIs de tipo permiten identificar errores rápidamente
4. **Extensibilidad**: Fácil agregar nuevos tipos de problemas
5. **Estándar**: Sigue especificación IETF reconocida

---

**Última Actualización**: 2025-11-18
